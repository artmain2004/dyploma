services:
  postgres:
    image: postgres:16
    container_name: identity-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: Identity
    ports:
      - "5433:5432"
    networks:
      - identity-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d Identity"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data

  identity:
    image: ${DOCKER_REGISTRY-}identity
    container_name: identity-api
    env_file:
      - .env
    build:
      context: .
      dockerfile: Identity/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - identity-network
    environment:
      RabbitMq__Host: rabbitmq
      RabbitMq__Username: guest
      RabbitMq__Password: guest

  catalog-postgres:
    image: postgres:16
    container_name: catalog-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: Catalog
    ports:
      - "5434:5432"
    networks:
      - identity-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d Catalog"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - catalog_pgdata:/var/lib/postgresql/data

  order-postgres:
    image: postgres:16
    container_name: order-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: Orders
    ports:
      - "5435:5432"
    networks:
      - identity-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d Orders"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - order_pgdata:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - identity-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  catalog:
    image: ${DOCKER_REGISTRY-}catalogservice
    container_name: catalog-api
    build:
      context: .
      dockerfile: Catalog/Dockerfile
    depends_on:
      catalog-postgres:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: Host=catalog-postgres;Port=5432;Database=Catalog;Username=postgres;Password=password
      Jwt__Issuer: IdentityApi
      Jwt__Audience: IdentityApiClient
      Jwt__SigningKey: CHANGE_ME_SUPER_SECRET_KEY_32+_CHARS_MINIMUM
      AzureBlob__ConnectionString: ${AZURE_BLOB_CONNECTION_STRING}
      AzureBlob__ContainerName: ${AZURE_BLOB_CONTAINER_NAME:-product-images}
    ports:
      - "8081:8080"
    networks:
      - identity-network

  order:
    image: ${DOCKER_REGISTRY-}orderservice
    container_name: order-api
    build:
      context: .
      dockerfile: Order/Dockerfile
    depends_on:
      order-postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: Host=order-postgres;Port=5432;Database=Orders;Username=postgres;Password=password
      Jwt__Issuer: IdentityApi
      Jwt__Audience: IdentityApiClient
      Jwt__SigningKey: CHANGE_ME_SUPER_SECRET_KEY_32+_CHARS_MINIMUM
      RabbitMq__Host: rabbitmq
      RabbitMq__Username: guest
      RabbitMq__Password: guest
    ports:
      - "8082:8080"
    networks:
      - identity-network

  notification:
    image: ${DOCKER_REGISTRY-}notificationservice
    container_name: notification-api
    build:
      context: .
      dockerfile: Notification/Dockerfile
    env_file:
      - .env
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      RabbitMq__Host: rabbitmq
      RabbitMq__Username: guest
      RabbitMq__Password: guest
    ports:
      - "8083:8080"
    networks:
      - identity-network

  frontend:
    image: ${DOCKER_REGISTRY-}storefront
    container_name: storefront
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_AUTH_URL: http://localhost:8080
        VITE_CATALOG_URL: http://localhost:8081
        VITE_ORDERS_URL: http://localhost:8082
    depends_on:
      - identity
      - catalog
      - order
    ports:
      - "5173:5173"
    networks:
      - identity-network

volumes:
  pgdata:
  catalog_pgdata:
  order_pgdata:

networks:
  identity-network:
    driver: bridge
